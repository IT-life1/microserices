name: Kind Cluster and PostgreSQL Deployment

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  setup-kind-cluster:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Verify Docker
      - name: Verify Docker
        run: |
          docker --version
          sudo systemctl start docker
          sudo chmod 666 /var/run/docker.sock

      # Step 3: Verify kubectl
      - name: Verify kubectl
        run: |
          kubectl version --client

      # Step 4: Install Kind
      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      # Step 5: Create a multi-node Kind cluster
      - name: Create Kind cluster with 3 nodes
        run: |
          cat <<EOF | kind create cluster --name my-cluster --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
            - role: control-plane
            - role: worker
            - role: worker
            - role: worker
          EOF
          kubectl cluster-info

      # Step 6: Deploy PostgreSQL from manifests
      - name: Deploy PostgreSQL
        run: |
          kubectl apply -f Postgres/ -n default

      # Step 7: Wait for PostgreSQL pod to be ready
      - name: Wait for PostgreSQL
        run: |
          kubectl wait --for=condition=Ready pod -l app=auth-app --timeout=300s

      # Step 10: Verify PostgreSQL connection
      - name: Verify PostgreSQL connection
        run: |
          POSTGRES_POD=$(kubectl get pod -l app=postgres -o jsonpath="{.items[0].metadata.name}")
          kubectl exec -it $POSTGRES_POD -- psql -U alex -d authdb -c "SELECT 'Connected!';"

      # Step 11: Debugging steps
      - name: Show cluster resources
        run: |
          echo "Pods status:"
          kubectl get pods --all-namespaces
          echo "Persistent Volumes:"
          kubectl get pv
          echo "Persistent Volume Claims:"
          kubectl get pvc
          echo "Services:"
          kubectl get svc

      - name: Check PostgreSQL logs
        run: |
          POSTGRES_POD=$(kubectl get pod -l app=postgres -o jsonpath="{.items[0].metadata.name}")
          kubectl logs $POSTGRES_POD
